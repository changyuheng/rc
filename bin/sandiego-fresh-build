#!/usr/bin/env bash
# Author: Andrew Chen <yongjhih@gmail.com>
# CC, Creative Commons
#
. /home/andrew/.bashrc
WORKSPACE="/home/andrew/workspace/sandiego"
PROJECTS="`echo daily/{dsds,ssss}/{pure,base}/android`"
GBC_FEATURE_PROVIDER_PATH="/home/andrew/workspace/GbcFeatureProvider"
BACKUP_LIST=""

#repo init -u "sandiego_dev@git.gbc.intra:android/platform/manifest.git" -b "sku1/M76XXTSNCJNLYA60401002_DSDS_dvt2_w1103" --reference="/home/andrew/workspace/sandiego/mirror"

function build() {
	echo "cd $1"
	cd "$1" || return 1
	shift

	local GBC_FEATURE_PROVIDER="$1"
	shift

	repo forall -c "git reset --hard && git clean -df"
	#repo forall -p -c "git checkout sku1/M76XXTSNCJNLYA60401002_7050_DSDS_dvt2_w1104"
	repo sync

	. /home/andrew/.andrchoose

	if [ -f "$GBC_FEATURE_PROVIDER" ]; then
		echo "add features"
		#feature_switch.py --auto_merge=/dev/shm/merge -p ~/workspace/GbcFeatureProvider/project_config/GSmart_DSDS.cfg
		"$GBC_FEATURE_PROVIDER_PATH/tools/feature_switch.py" -n --auto_merge="/dev/shm/merge.$$" -p "$GBC_FEATURE_PROVIDER"
	else
		echo "no features added"
	fi
	mkctagscope

	make clean
	make
}

function backup() {
	# TODO backup system.img, boot.img, userdata, recovery.img, system/
	return 0
}

echo "repo-sync $WORKSPACE/mirror"
repo-sync "$WORKSPACE/mirror" || echo "mirror: repo-sync fail"

#echo "repo-sync $WORKSPACE/daily/dsds/base/android"
#repo-sync "$WORKSPACE/daily/dsds/base/android" || echo "base: repo-sync fail"

echo "build $WORKSPACE/daily/dsds/pure/android"
build "$WORKSPACE/daily/dsds/pure/android"
backup

#echo "repo-sync $WORKSPACE/daily/dsds/base/android"
#repo-sync "$WORKSPACE/daily/dsds/base/android" || echo "pure: repo-sync fail"

echo "build $WORKSPACE/daily/dsds/base/android $GBC_FEATURE_PROVIDER_PATH/project_config/GSmart_DSDS.cfg"
build "$WORKSPACE/daily/dsds/base/android" "$GBC_FEATURE_PROVIDER_PATH/project_config/GSmart_DSDS.cfg"
backup

echo "build $WORKSPACE/daily/dsds/base_7050/android $GBC_FEATURE_PROVIDER_PATH/project_config/GSmart_DSDS.cfg"
build "$WORKSPACE/daily/dsds/base_7050/android" "$GBC_FEATURE_PROVIDER_PATH/project_config/GSmart_DSDS.cfg"
backup

